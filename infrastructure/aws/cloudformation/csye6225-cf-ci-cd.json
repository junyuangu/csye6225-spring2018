{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "csye6225 spring2018 for assignment 6&7",

    "Resources" : {

        "CodeDeployEC2S3Policy":{
           "Type":"AWS::IAM::Policy",
           "Properties":{
              "PolicyName":"CodeDeploy-EC2-S3",
              "PolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement":[ {
                     "Action":[
                        "s3:*"
                     ],
                     "Effect":"Allow",
                     "Resource":   [
                         "*"
                     ]
                 } ]
              },
              "Roles":[
                { "Ref" : "RoleForCodeDeployEC2Service" }
              ]
           }
        },

        "TravisUploadToS3Policy":{
           "Type":"AWS::IAM::ManagedPolicy",
           "Properties" : {
              "ManagedPolicyName" : "Travis-Upload-To-S3",
              "PolicyDocument" : {
                 "Version" : "2012-10-17",
                 "Statement" : [ {
                     "Action" : [
                         "s3:PutObject"
                     ],
                     "Effect" : "Allow",
                     "Resource" : [
                         "*"
                     ]
                 } ]
              },
              "Users" : [ { "Ref" : "UserFromTravis" } ]
           }
        },

        "TravisCodeDeployPolicy" : {
           "Type":"AWS::IAM::ManagedPolicy",
           "Properties":{
              "ManagedPolicyName":"Travis-Code-Deploy",
              "PolicyDocument":{
                 "Version": "2012-10-17",
                 "Statement": [
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:RegisterApplicationRevision",
                       "codedeploy:GetApplicationRevision"
                     ],
                     "Resource": {
                       "Fn::Join" : [ "",
                         [
                            "arn:aws:codedeploy:us-east-1:",
                            { "Ref" : "AWS::AccountId" },
                            ":application:csye6225-spring2018"
                         ]
                       ]
                     }
                   },
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:CreateDeployment",
                       "codedeploy:GetDeployment"
                     ],
                     "Resource": [
                       "*"
                     ]
                   },
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource": [
                          {
                            "Fn::Join": [ "",
                                [ "arn:aws:codedeploy:us-east-1:",{ "Ref": "AWS::AccountId" },":deploymentconfig:CodeDeployDefault.OneAtATime" ]
                            ]
                          },
                          {
                            "Fn::Join": [ "",
                                [ "arn:aws:codedeploy:us-east-1:", { "Ref": "AWS::AccountId" }, ":deploymentconfig:CodeDeployDefault.HalfAtATime" ]
                            ]
                          },
                          {
                            "Fn::Join": [ "",
                                [ "arn:aws:codedeploy:us-east-1:", { "Ref": "AWS::AccountId" }, ":deploymentconfig:CodeDeployDefault.AllAtOnce" ]
                            ]
                          }
                     ]
                   }
                 ]
              },
              "Users" : [ { "Ref" : "UserFromTravis" } ]
           }
        },

        "RoleForCodeDeployEC2Service":{
           "Type":"AWS::IAM::Role",
           "Properties":{
              "AssumeRolePolicyDocument": {
                 "Version":"2012-10-17",
                 "Statement":[ {
                       "Effect":"Allow",
                       "Principal":{
                          "Service":[
                             "ec2.amazonaws.com"
                          ]
                       },
                       "Action":[ "sts:AssumeRole" ]
                 } ]
              },
              "Path":"/",
              "RoleName" : "CodeDeployEC2ServiceRole"
           }
        },

        "RoleForCodeDeployService": {
           "Type":"AWS::IAM::Role",
           "Properties":{
              "RoleName": "CodeDeployServiceRole",
              "AssumeRolePolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement": [ {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.amazonaws.com"
                        ]
                     },
                     "Action":[ "sts:AssumeRole" ]
                 } ]
              },
              "Path":"/",
              "ManagedPolicyArns": [
                  "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
              ]
          }
        },

        "S3BucketForCodeDeploy" : {
          	"Type": "AWS::S3::Bucket",
          	"Properties" : {
          	   "BucketName" : { "Ref" : "CodeDeployS3BucketName" }
            }
      	},

        "CodeDeployApplication": {
            "Type": "AWS::CodeDeploy::Application",
            "Properties" : {
                "ApplicationName" : { "Ref" : "CodeDeployAppName" },
                "ComputePlatform" : "Server"
            }
        },

        "DeploymentConfig" : {
          "Type" : "AWS::CodeDeploy::DeploymentConfig",
          "Properties" : {
            "MinimumHealthyHosts" : {
              "Type" : { "Ref" : "DeploymentCfgType" },
              "Value" : { "Ref" : "DeploymentCfgValue" }
            }
          }
        },

        "DeploymentGroup" : {
            "Type" : "AWS::CodeDeploy::DeploymentGroup",
            "Properties" : {
                "ApplicationName" : { "Ref" : "CodeDeployAppName" },
                "DeploymentGroupName": {
                    "Ref" : "NameOfDeploymentGroup"
                 },
                "Ec2TagFilters" : [ {
                    "Key" : { "Ref" : "TagKey" },
                    "Value" : { "Ref" : "TagValue" },
                    "Type" : "KEY_AND_VALUE"
                } ],
                "ServiceRoleArn" : { "Fn::GetAtt" : [ "RoleForCodeDeployService", "Arn" ] }
            },
            "DependsOn": [ "CodeDeployApplication" ]
        }

    },

    "Parameters" : {

      "UserFromTravis" : {
        "Description" : "User who uses TravisCI",
        "Type" : "String",
        "Default" : "travisUser"
      },

      "CodeDeployAppName" : {
        "Description" : "CodeDeploy Application Name",
        "Type" : "String",
        "Default" : "MyApplication"
      },

      "CodeDeployS3BucketName" : {
        "Description" : "S3 Bucket which is used by CodeDeploy",
        "Type" : "String",
        "Default" : "code-deploy.csye6225-spring2018-guju.me"
      },

      "NameOfDeploymentGroup" : {
        "Description" : "Deployment Group Name",
        "Type" : "String",
        "Default" : "MyApplication_deployment"
      },

      "DeploymentCfgType" : {
        "Description" : "Deployment Configuration Param",
        "Type" : "String",
        "Default" : "FLEET_PERCENT"
      },

      "DeploymentCfgValue" : {
        "Description" : "Deployment Configuration Param",
        "Type" : "String",
        "Default" : "75"
      },

      "S3Key" : {
        "Description" : "S3 Object key that points to the deployment bundle",
        "Type" : "String",
        "Default" : "MyApplication.zip"
      },

      "TagKey" : {
        "Description" : " EC2 instance tag Key ",
        "Type" : "String",
        "Default" : "Name"
      },

      "TagValue" : {
        "Description" : " EC2 instance tag Value ",
        "Type" : "String",
        "Default" : "MyEC2ForCodeDeployInstance"
      }

    }
}
