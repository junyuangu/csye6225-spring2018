{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "csye6225 spring2018 for assignment 6&7",
    "Resources" : {

      "FinalEC2InsPolicy" : {
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"FinalEC2InsPolicy",
            "PolicyDocument" : {
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "autoscaling:CompleteLifecycleAction",
                        "autoscaling:DeleteLifecycleHook",
                        "autoscaling:DescribeAutoScalingGroups",
                        "autoscaling:DescribeLifecycleHooks",
                        "autoscaling:PutLifecycleHook",
                        "autoscaling:RecordLifecycleActionHeartbeat",
                        "autoscaling:CreateAutoScalingGroup",
                        "autoscaling:UpdateAutoScalingGroup",
                        "autoscaling:EnableMetricsCollection",
                        "autoscaling:DescribeAutoScalingGroups",
                        "autoscaling:DescribePolicies",
                        "autoscaling:DescribeScheduledActions",
                        "autoscaling:DescribeNotificationConfigurations",
                        "autoscaling:DescribeLifecycleHooks",
                        "autoscaling:SuspendProcesses",
                        "autoscaling:ResumeProcesses",
                        "autoscaling:AttachLoadBalancers",
                        "autoscaling:PutScalingPolicy",
                        "autoscaling:PutScheduledUpdateGroupAction",
                        "autoscaling:PutNotificationConfiguration",
                        "autoscaling:PutLifecycleHook",
                        "autoscaling:DescribeScalingActivities",
                        "autoscaling:DeleteAutoScalingGroup",
                        "ec2:DescribeInstances",
                        "ec2:DescribeInstanceStatus",
                        "ec2:TerminateInstances",
                        "tag:GetTags",
                        "tag:GetResources",
                        "sns:Publish",
                        "cloudwatch:DescribeAlarms",
                        "cloudwatch:PutMetricAlarm",
                        "elasticloadbalancing:DescribeLoadBalancers",
                        "elasticloadbalancing:DescribeInstanceHealth",
                        "elasticloadbalancing:RegisterInstancesWithLoadBalancer",
                        "elasticloadbalancing:DeregisterInstancesFromLoadBalancer",
                        "elasticloadbalancing:DescribeTargetGroups",
                        "elasticloadbalancing:DescribeTargetHealth",
                        "elasticloadbalancing:RegisterTargets",
                        "elasticloadbalancing:DeregisterTargets"
                     ],
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"RoleForCodeDeployEC2Service"
               }
            ]
          }
        },

        "WebServerScaleUpPolicy": {
          "Type": "AWS::AutoScaling::ScalingPolicy",
          "Properties": {
            "AdjustmentType": "ChangeInCapacity",
            "AutoScalingGroupName": {
              "Ref": "WebServerGroup"
            },
            "Cooldown": "60",
            "ScalingAdjustment": "1"
          }
        },
        "WebServerScaleDownPolicy": {
          "Type": "AWS::AutoScaling::ScalingPolicy",
          "Properties": {
            "AdjustmentType": "ChangeInCapacity",
            "AutoScalingGroupName": {
              "Ref": "WebServerGroup"
            },
            "Cooldown": "60",
            "ScalingAdjustment": "-1"
          }
        },
        "CPUAlarmHigh": {
          "Type": "AWS::CloudWatch::Alarm",
          "Properties": {
            "AlarmDescription": "Scale-up if CPU > 90% for 10 minutes",
            "MetricName": "CPUUtilization",
            "Namespace": "AWS/EC2",
            "Statistic": "Average",
            "Period": "300",
            "EvaluationPeriods": "2",
            "Threshold": "90",
            "AlarmActions": [
              {
                "Ref": "WebServerScaleUpPolicy"
              }
            ],
            "Dimensions": [
              {
                "Name": "AutoScalingGroupName",
                "Value": {
                  "Ref": "WebServerGroup"
                }
              }
            ],
            "ComparisonOperator": "GreaterThanThreshold"
          }
        },
        "CPUAlarmLow": {
          "Type": "AWS::CloudWatch::Alarm",
          "Properties": {
            "AlarmDescription": "Scale-down if CPU < 70% for 10 minutes",
            "MetricName": "CPUUtilization",
            "Namespace": "AWS/EC2",
            "Statistic": "Average",
            "Period": "300",
            "EvaluationPeriods": "2",
            "Threshold": "70",
            "AlarmActions": [
              {
                "Ref": "WebServerScaleDownPolicy"
              }
            ],
            "Dimensions": [
              {
                "Name": "AutoScalingGroupName",
                "Value": {
                  "Ref": "WebServerGroup"
                }
              }
            ],
            "ComparisonOperator": "LessThanThreshold"
          }
        },


        "CodeDeployEC2S3Policy" : {
           "Type":"AWS::IAM::Policy",
           "Properties":{
              "PolicyName":"CodeDeploy-EC2-S3",
              "PolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement":[
                   {
                     "Action" : [
                        "s3:*"
                     ],
                     "Effect":"Allow",
                     "Resource" : "*"
                   },
                   {
                     "Action" : [
                        "sns:*"
                     ],
                     "Effect" : "Allow",
                     "Resource" : "*"
                   }
                 ]
              },
              "Roles":[
                { "Ref" : "RoleForCodeDeployEC2Service" }
              ]
           }
        },

        "TravisUploadToS3Policy":{
           "Type":"AWS::IAM::ManagedPolicy",
           "Properties" : {
              "ManagedPolicyName" : "Travis-Upload-To-S3",
              "PolicyDocument" : {
                 "Version" : "2012-10-17",
                 "Statement" : [ {
                     "Action" : [
                         "s3:PutObject"
                     ],
                     "Effect" : "Allow",
                     "Resource" : [ "*" ]
                 } ]
              },
              "Users" : [ { "Ref" : "UserFromTravis" } ]
           }
        },

        "TravisCodeDeployPolicy" : {
           "Type":"AWS::IAM::ManagedPolicy",
           "Properties":{
              "ManagedPolicyName":"Travis-Code-Deploy",
              "PolicyDocument":{
                 "Version": "2012-10-17",
                 "Statement": [
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:RegisterApplicationRevision",
                       "codedeploy:GetApplicationRevision"
                     ],
                     "Resource": {
                       "Fn::Join" : [ "",
                         [
                            "arn:aws:codedeploy:us-east-1:",
                            { "Ref" : "AWS::AccountId" },
                            ":application:",
                            { "Ref" : "CodeDeployAppName" }
                         ]
                       ]
                     }
                   },
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:CreateDeployment",
                       "codedeploy:GetDeployment"
                     ],
                     "Resource": [
                       "*"
                     ]
                   },
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource": [
                          {
                            "Fn::Join": [ "",
                                [ "arn:aws:codedeploy:us-east-1:",{ "Ref": "AWS::AccountId" },":deploymentconfig:CodeDeployDefault.OneAtATime" ]
                            ]
                          },
                          {
                            "Fn::Join": [ "",
                                [ "arn:aws:codedeploy:us-east-1:", { "Ref": "AWS::AccountId" }, ":deploymentconfig:CodeDeployDefault.HalfAtATime" ]
                            ]
                          },
                          {
                            "Fn::Join": [ "",
                                [ "arn:aws:codedeploy:us-east-1:", { "Ref": "AWS::AccountId" }, ":deploymentconfig:CodeDeployDefault.AllAtOnce" ]
                            ]
                          }
                     ]
                   }
                 ]
              },
              "Users" : [ { "Ref" : "UserFromTravis" } ]
           }
        },

        "RoleForCodeDeployEC2Service":{
           "Type":"AWS::IAM::Role",
           "Properties":{
              "AssumeRolePolicyDocument": {
                 "Version":"2012-10-17",
                 "Statement":[ {
                       "Effect":"Allow",
                       "Principal":{
                          "Service":[
                             "ec2.amazonaws.com"
                          ]
                       },
                       "Action":[ "sts:AssumeRole" ]
                 } ]
              },
              "Path":"/",
              "RoleName" : "CodeDeployEC2ServiceRole"
           }
        },

        "RoleForCodeDeployService": {
           "Type":"AWS::IAM::Role",
           "Properties":{
              "RoleName": "CodeDeployServiceRole",
              "AssumeRolePolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement": [ {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.amazonaws.com"
                        ]
                     },
                     "Action":[ "sts:AssumeRole" ]
                 } ]
              },
              "Path":"/",
              "ManagedPolicyArns": [
                  "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
              ]
          }
        },

        "CloudWatchPolicy": {
      			"Type": "AWS::IAM::ManagedPolicy",
      			"Properties": {
      				"Roles": [
                  { "Ref" : "RoleForCodeDeployService" },
                  { "Ref" : "RoleForLambda" }
              ],
      				"ManagedPolicyName": "CloudWatch-Policy",
      				"PolicyDocument": {
      					"Version": "2012-10-17",
      					"Statement": [
                  {
        						"Effect": "Allow",
        						"Action": [
        							"logs:CreateLogGroup",
        							"logs:CreateLogStream",
        							"logs:PutLogEvents",
        							"logs:DescribeLogStreams"
        						],
        						"Resource": [
        							"arn:aws:logs:*:*:*"
        						]
      					  }
                ]
      				}
      			}
      	},

        "S3BucketForCodeDeploy" : {
          	"Type": "AWS::S3::Bucket",
          	"Properties" : {
          	   "BucketName" : { "Ref" : "CodeDeployS3BucketName" }
            }
      	},

        "CodeDeployApplication": {
            "Type": "AWS::CodeDeploy::Application",
            "Properties" : {
                "ApplicationName" : { "Ref" : "CodeDeployAppName" },
                "ComputePlatform" : "Server"
            }
        },

        "DeploymentGroup" : {
            "Type" : "AWS::CodeDeploy::DeploymentGroup",
            "Properties" : {
                "ApplicationName" : { "Ref" : "CodeDeployAppName" },
                "DeploymentConfigName" : "CodeDeployDefault.OneAtATime",
                "DeploymentGroupName": {
                    "Ref" : "NameOfDeploymentGroup"
                 },
                "Ec2TagFilters" : [ {
                    "Key" : { "Ref" : "TagKey" },
                    "Value" : { "Ref" : "TagValue" },
                    "Type" : "KEY_AND_VALUE"
                } ],
                "ServiceRoleArn" : { "Fn::GetAtt" : [ "RoleForCodeDeployService", "Arn" ] }
            },
            "DependsOn": [
              "CodeDeployApplication"
            ]
        },

        "RoleForLambda" : {
           "Type" : "AWS::IAM::Role",
           "Properties" : {
              "AssumeRolePolicyDocument" : {
                 "Version" : "2012-10-17",
                 "Statement" : [
                   {
                       "Effect" : "Allow",
                       "Principal" : {
                          "Service" : [
                             "lambda.amazonaws.com"
                          ]
                       },
                       "Action" : [
                          "sts:AssumeRole"
                       ]
                   }
                 ]
              },
              "ManagedPolicyArns": [
        					"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      				],
              "Path" : "/",
              "RoleName": "lambdafunc-execution-role"
           }
        },

        "DynamoDBSESAccessPolicy" : {
            "Type" : "AWS::IAM::Policy",
            "Properties" : {
               "PolicyName" : "Lambda-Access-DynamoDB-SES-Policy",
               "PolicyDocument" : {
                  "Version" : "2012-10-17",
                  "Statement" : [
                    {
                      "Action" : [
                         "dynamodb:*"
                      ],
                      "Effect" : "Allow",
                      "Resource" : "*"
                    },
                    {
                      "Action" : [
                         "ses:*"
                      ],
                      "Effect" : "Allow",
                      "Resource" : "*"
                    }
                  ]
               },
               "Roles" : [
                 { "Ref" : "RoleForLambda" }
               ]
            }
        },

        "LambdaFuncInsProfile" : {
      			"Type" : "AWS::IAM::InstanceProfile",
      			"Properties": {
      				"Path" : "/",
      				"Roles" : [
                { "Ref" : "RoleForLambda" }
              ]
      			}
    		}

    },

    "Parameters" : {

      "UserFromTravis" : {
        "Description" : "User who uses TravisCI",
        "Type" : "String",
        "Default" : "travisUser"
      },

      "CodeDeployAppName" : {
        "Description" : "CodeDeploy Application Name",
        "Type" : "String",
        "Default" : "MyApplication"
      },

      "CodeDeployS3BucketName" : {
        "Description" : "S3 Bucket which is used by CodeDeploy",
        "Type" : "String",
        "Default" : "code-deploy.csye6225-spring2018-guju.me"
      },

      "NameOfDeploymentGroup" : {
        "Description" : "Deployment Group Name",
        "Type" : "String",
        "Default" : "MyApplication-deployment-group"
      },

      "TagKey" : {
        "Description" : " EC2 instance tag Key ",
        "Type" : "String",
        "Default" : "Name"
      },

      "TagValue" : {
        "Description" : " EC2 instance tag Value ",
        "Type" : "String",
        "Default" : "MyEC2ForCodeDeployInstance"
      }

    }
}
