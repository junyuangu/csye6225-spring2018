{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "csye6225 spring2018 for assignment6&7",
    "Resources" : {
        "CodeDeployIAMPolicy":{
           "Type":"AWS::IAM::Policy",
           "Properties":{
              "PolicyName":"CodeDeployIAMPolicy",
              "PolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement":[ {
                       "Effect":"Allow",
                       "Action":[
                         "autoscaling:*",
                         "codedeploy:*",
                         "ec2:*",
                         "lambda:*",
                         "elasticloadbalancing:*",
                         "iam:AddRoleToInstanceProfile",
                         "iam:CreateInstanceProfile",
                         "iam:CreateRole",
                         "iam:DeleteInstanceProfile",
                         "iam:DeleteRole",
                         "iam:DeleteRolePolicy",
                         "iam:GetInstanceProfile",
                         "iam:GetRole",
                         "iam:GetRolePolicy",
                         "iam:ListInstanceProfilesForRole",
                         "iam:ListRolePolicies",
                         "iam:ListRoles",
                         "iam:PassRole",
                         "iam:PutRolePolicy",
                         "iam:RemoveRoleFromInstanceProfile",
                         "s3:*"
                       ],
                       "Resource":"*"
                 } ]
              },
              "Roles":[
                 {
                    "Ref":"CodeDeployServiceRole"
                 }
              ]
           }
        },

        "CodeDeployEC2S3Policy":{
           "Type":"AWS::IAM::Policy",
           "Properties":{
              "PolicyName":"CodeDeployEC2S3Policy",
              "PolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement":[ {
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Effect":"Allow",
                     "Resource": [
                       "arn:aws:s3:::aws-codedeploy-us-east-1/*",
                       "arn:aws:s3:::S3Bucket/*"
                     ]
                 } ]
              },
              "Roles":[ {
                  "Ref":"EC2ServiceRole"
              } ]
           }
        },

          "EC2ServiceRole":{
             "Type":"AWS::IAM::Role",
             "Properties":{
                "AssumeRolePolicyDocument": {
                   "Version":"2012-10-17",
                   "Statement":[ {
                         "Effect":"Allow",
                         "Principal":{
                            "Service":[
                               "ec2.amazonaws.com"
                            ]
                         },
                         "Action":[ "sts:AssumeRole" ]
                   } ]
                },
                "Path":"/"
             }
          },

          "CodeDeployServiceRole": {
             "Type":"AWS::IAM::Role",
             "Properties":{
                "AssumeRolePolicyDocument":{
                   "Version":"2012-10-17",
                   "Statement": [ {
                       "Effect":"Allow",
                       "Principal":{
                          "Service":[
                             "codedeploy.us-east-1.amazonaws.com"
                          ]
                       },
                       "Action":[ "sts:AssumeRole" ]
                   } ]
                },
                "Path":"/"
            }
          },

          "S3Bucket" : {
            	"Type": "AWS::S3::Bucket",
            	"Properties" : {
            	   "BucketName" : "code-deploy.csye6225-spring2018-guju.me"
              }
        	},

    }
}
