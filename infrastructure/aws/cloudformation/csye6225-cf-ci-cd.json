{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "csye6225 spring2018 for assignment6&7",

    "Resources" : {

        "CodeDeployEC2S3Policy":{
           "Type":"AWS::IAM::Policy",
           "Properties":{
              "PolicyName":"CodeDeploy-EC2-S3",
              "PolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement":[ {
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Effect":"Allow",
                     "Resource":   [
                         "arn:aws:s3:::aws-codedeploy-us-east-1/*",
                         "arn:aws:s3:::aws-codedeploy-us-east-2/*",
                         "arn:aws:s3:::code-deploy.csye6225-spring2018-guju.me/*"
                     ]
                 } ]
              },
              "Roles":[ {
                  "Ref" : "CodeDeployEC2ServiceRole"
              } ]
           }
        },

        "TravisUploadToS3Policy":{
           "Type":"AWS::IAM::ManagedPolicy",
           "Properties" : {
              "ManagedPolicyName" : "Travis-Upload-To-S3",
              "PolicyDocument" : {
                 "Version" : "2012-10-17",
                 "Statement" : [ {
                     "Action" : [
                         "s3:PutObject"
                     ],
                     "Effect" : "Allow",
                     "Resource" : [
                         "*"
                     ]
                 } ]
              },
              "Users" : [ { "Ref" : "UserFromTravis" } ]
           }
        },

        "TravisCodeDeployPolicy" : {
           "Type":"AWS::IAM::ManagedPolicy",
           "Properties":{
              "ManagedPolicyName":"Travis-Code-Deploy",
              "PolicyDocument":{
                 "Version": "2012-10-17",
                 "Statement": [
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:RegisterApplicationRevision",
                       "codedeploy:GetApplicationRevision"
                     ],
                     "Resource": {
                       "FN::Join" : [ "",
                         [
                            "arn:aws:codedeploy:us-east-1:",
                            { "Ref" : "AWS::AccountId" },
                            ":application:",
                            { "Ref" : "CodeDeployAppName" }
                         ]
                       ]
                     }
                   },
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:CreateDeployment",
                       "codedeploy:GetDeployment"
                     ],
                     "Resource": [
                       "*"
                     ]
                   },
                   {
                     "Effect": "Allow",
                     "Action": [
                       "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource": [
                         { "FN::Join" : [ "",
                             [ "arn:aws:codedeploy:us-east-1:", {"Ref":"AWS::AccountId"}, ":CodeDeployDefault.OneAtATime" ],
                             [ "arn:aws:codedeploy:us-east-1:", {"Ref":"AWS::AccountId"}, ":CodeDeployDefault.HalfAtATime" ],
                             [ "arn:aws:codedeploy:us-east-1:", {"Ref":"AWS::AccountId"}, ":CodeDeployDefault.AllAtOnce" ]
                           ]
                         }
                     ]
                   }
                 ]
              },
              "Users" : [ { "Ref" : "UserFromTravis" } ]
           }
        },

        "CodeDeployEC2ServiceRole":{
           "Type":"AWS::IAM::Role",
           "Properties":{
              "AssumeRolePolicyDocument": {
                 "Version":"2012-10-17",
                 "Statement":[ {
                       "Effect":"Allow",
                       "Principal":{
                          "Service":[
                             "ec2.amazonaws.com"
                          ]
                       },
                       "Action":[ "sts:AssumeRole" ]
                 } ]
              },
              "Path":"/",
              "RoleName" : "CodeDeployEC2ServiceRole"
           }
        },

        "CodeDeployServiceRole": {
           "Type":"AWS::IAM::Role",
           "Properties":{
              "AssumeRolePolicyDocument":{
                 "Version":"2012-10-17",
                 "Statement": [ {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.amazonaws.com"
                        ]
                     },
                     "Action":[ "sts:AssumeRole" ]
                 } ]
              },
              "Path":"/",
              "ManagedPolicyArns": [
                  "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
              ]
          }
        },

        "S3BucketForCodeDeploy" : {
          	"Type": "AWS::S3::Bucket",
          	"Properties" : {
          	   "BucketName" : { "Ref" : "CodeDeployS3BucketName" }
            }
      	},

        "CodeDeployApplication": {
            "Type": "AWS::CodeDeploy::Application",
            "Properties" : {
                "ApplicationName" : { "Ref" : "CodeDeployAppName" },
                "ComputePlatform" : "Server"
            }
        },

        "DeploymentConfig" : {
          "Type" : "AWS::CodeDeploy::DeploymentConfig",
          "Properties" : {
            "MinimumHealthyHosts" : {
              "Type" : { "Ref" : "DeploymentCfgType" },
              "Value" : { "Ref" : "DeploymentCfgValue" }
            }
          }
        },

        "DeploymentGroup" : {
            "Type" : "AWS::CodeDeploy::DeploymentGroup",
            "Properties" : {
                "ApplicationName" : { "Ref" : "CodeDeployAppName" },
                "DeploymentGroupName": {
                    "Fn::Join": [ "",
                      [
                        { "Ref" : "CodeDeployApplication" },
                        "DeploymentGroup_Fleet"
                      ]
                    ]
                },
                "AutoScalingGroups" : [ {"Ref" : "AutoScalingGroup" } ],
                "Deployment" : {
                    "Description" : "MyApplication deployment",
                    "Revision" : {
                        "RevisionType" : "S3",
                        "S3Location" : {
                          "Bucket" : { "Ref" : "S3BucketForCodeDeploy" },
                          "Key" : { "Ref" : "S3Key" },
                          "BundleType" : "Zip"
                        }
                    }
                },
                "Ec2TagFilters" : [ {
                    "Key" : { "Ref" : "TagKey" },
                    "Value" : { "Ref" : "TagValue" },
                    "Type" : "KEY_AND_VALUE"
                } ],
                "ServiceRoleArn" : { "Fn::GetAtt" : [ "CodeDeployServiceRole", "Arn" ] }
            },
            "DependsOn": [ "CodeDeployApplication" ]
        }

    },

    "Parameters" : {

      "UserFromTravis" : {
        "Description" : "User who uses TravisCI",
        "Type" : "String",
        "Default" : "travisUser"
      },

      "CodeDeployAppName" : {
        "Description" : "CodeDeploy Application Name",
        "Type" : "String",
        "Default" : "MyApplication"
      },

      "CodeDeployS3BucketName" : {
        "Description" : "S3 Bucket which is used by CodeDeploy",
        "Type" : "String",
        "Default" : "code-deploy.csye6225-spring2018-guju.me"
      },

      "DeploymentCfgType" : {
        "Description" : "Deployment Configuration Param",
        "Type" : "String",
        "Default" : "FLEET_PERCENT"
      },

      "DeploymentCfgValue" : {
        "Description" : "Deployment Configuration Param",
        "Type" : "String",
        "Default" : "75"
      },

      "S3Key" : {
        "Description" : "S3 Object key that points to the deployment bundle",
        "Type" : "String",
        "Default" : "MyApplication.zip"
      },

      "TagKey" : {
        "Description" : " EC2 instance tag Key ",
        "Type" : "String",
        "Default" : "Name"
      },

      "TagValue" : {
        "Description" : " EC2 instance tag Value ",
        "Type" : "String",
        "Default" : "MyEC2ForCodeDeployInstance"
      }

    }
}
