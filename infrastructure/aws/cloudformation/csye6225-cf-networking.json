{

  "Description" : "This template is for csye6225-spring2018 assignment5.",

  "Resources" : {
    "VPC" : {
        "Type" : "AWS::EC2::VPC",
        "Properties" : {
	         "CidrBlock" : "10.0.0.0/16",
           "Tags" : [{
                "Key" : "Name",
                "Value" : { "Ref" : "InstanceName" }
           }]
        }
    },

    "PublicRouteTable" : {
        "Type" : "AWS::EC2::RouteTable",
        "Properties" : {
           "VpcId" : {
              "Ref" : "VPC"
           },
           "Tags" : [
            {
              "Key" : "Name",
              "Value" : {"Ref":"routeTableName"}
            }
        ]
        }
    },

    "PublicRoute" : {
        "DependsOn" : "AttachGateway",
        "Type" : "AWS::EC2::Route",
        "Properties" : {
           "GatewayId" : {
              "Ref" : "InternetGateway"
           },
           "DestinationCidrBlock" : "0.0.0.0/0",
           "RouteTableId" : {
              "Ref" : "PublicRouteTable"
           }
        }
    },

    "PublicSubnet" : {
        "Type" : "AWS::EC2::Subnet",
        "Properties" : {
           "VpcId" : {
              "Ref" : "VPC"
           },
           "CidrBlock" : "10.0.0.0/24",
	         "AvailabilityZone" : "us-east-1a"
        }
    },
    "SubnetRouteTableAssociation1" : {
         "Type" : "AWS::EC2::SubnetRouteTableAssociation",
         "Properties" : {
            "SubnetId" : { "Ref" : "PublicSubnet" },
            "RouteTableId" : { "Ref" : "PublicRouteTable" }
         }
    },



    "PrivateRouteTable" : {
         "Type" : "AWS::EC2::RouteTable",
         "Properties" : {
            "VpcId" : {
               "Ref" : "VPC"
            },
            "Tags" : [
             {
               "Key" : "Name",
               "Value" : {"Ref":"privaterouteTableName"}
             }
         ]
         }
     },
     "PrivateRoute" : {
         "DependsOn" : "AttachGateway",
         "Type" : "AWS::EC2::Route",
         "Properties" : {
            "GatewayId" : {
               "Ref" : "InternetGateway"
            },
            "DestinationCidrBlock" : "10.0.1.0/24",
            "RouteTableId" : {
               "Ref" : "PrivateRouteTable"
            }
         }
     },

   "PrivateSubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
         "VpcId" : {
            "Ref" : "VPC"
         },
         "CidrBlock" : "10.0.1.0/24",
         "AvailabilityZone" : "us-east-1c"
      }
   },
   "SubnetRouteTableAssociation2" : {
       "Type" : "AWS::EC2::SubnetRouteTableAssociation",
       "Properties" : {
          "SubnetId" : { "Ref" : "PrivateSubnet" },
          "RouteTableId" : { "Ref" : "PrivateRouteTable" }
       }
   },

   "InternetGateway" : {
        "Type" : "AWS::EC2::InternetGateway",
        "Properties" : {
            "Tags" : [
                {
                  "Key" : "Name",
                  "Value" : { "Ref" : "AWS::StackName" }
                }
            ]
        }
   },

   "AttachGateway" : {
        "Type" : "AWS::EC2::VPCGatewayAttachment",
        "Properties" : {
           "VpcId" : {
              "Ref" : "VPC"
           },
           "InternetGatewayId" : {
              "Ref" : "InternetGateway"
           }
        }
   },

    "myDBSubnetGroup" : {
         "Type" : "AWS::RDS::DBSubnetGroup",
         "Properties" : {
            "DBSubnetGroupDescription" : "description",
            "SubnetIds" : [ {"Ref" : "PublicSubnet"}, {"Ref" : "PrivateSubnet"} ],
            "Tags" : [
              {
                "Key" : "Name",
                "Value" : { "Ref" : "AWS::StackName" }
              }
            ]
         }
      },

      "WebServerSecurityGroup": {
          "Type": "AWS::EC2::SecurityGroup",
          "Properties": {
              "GroupName":"csye6225-webapp",
              "GroupDescription": "Enable HTTP access via port 80, SSH access via port 22, HTTPS access via port 443",
              "VpcId":{"Ref":"VPC"},
              "SecurityGroupIngress": [
                  {
                      "IpProtocol": "tcp",
                      "FromPort": "80",
                      "ToPort": "80",
                      "CidrIp": "0.0.0.0/0"
                  },
                  {
                      "IpProtocol": "tcp",
                      "FromPort": "22",
                      "ToPort": "22",
                      "CidrIp": "0.0.0.0/0"
                  },
                  {
                      "IpProtocol": "tcp",
                      "FromPort": "443",
                      "ToPort": "443",
                      "CidrIp": "0.0.0.0/0"
                  }
              ]
          }
       },


       "DBServerSecurityGroup": {
              "Type": "AWS::EC2::SecurityGroup",
              "Properties": {
                  "GroupName":"csye6225-rds",
                  "GroupDescription": "database",
                  "VpcId":{"Ref":"VPC"},
                  "SecurityGroupIngress": [ {
                          "IpProtocol": "tcp",
                          "FromPort": "3306",
                          "ToPort": "3306",
                          "SourceSecurityGroupId" : { "Ref" : "WebServerSecurityGroup" }
                   }]
              }
       },

       "DBSecurityGroup": {
              "Type": "AWS::RDS::DBSecurityGroup",
              "Properties": {
                  "GroupDescription": "allow visit to DB",
                  "EC2VpcId":{"Ref":"VPC"},
                  "DBSecurityGroupIngress": [
                    { "SourceSecurityGroupId" : { "Ref" : "DBServerSecurityGroup" } }
                  ]
              }
       }




    },

     "Parameters" : {
        "InstanceName" : {
          "Type" : "String"
       },

        "routeTableName" : {
            "Type" : "String"
        },
      	"privaterouteTableName" : {
      	    "Type" : "String"
      	}
     }

}
